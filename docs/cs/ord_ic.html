<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.537">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Edgar C. Merkle">
<meta name="dcterms.date" content="2022-11-10">
<meta name="description" content="This case study provides information about computing (approximating) likelihoods of structural equation models with ordinal variables. We consider interactions between theoretical results and computational issues, and we also consider the influence of likelihood approximations on information criteria like WAIC. Finally, we discuss how blavaan handles related issues.">

<title>Ed Merkle - Adventures in ordinal model likelihoods</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
<meta name="citation_title" content="Adventures in ordinal model likelihoods">
<meta name="citation_author" content="Edgar C. Merkle">
<meta name="citation_publication_date" content="2022-11-10">
<meta name="citation_cover_date" content="2022-11-10">
<meta name="citation_year" content="2022">
<meta name="citation_online_date" content="2022-11-10">
<meta name="citation_fulltext_html_url" content="https://ecmerkle.github.io/cs/ord_ic.html">
<meta name="citation_language" content="en">
<meta name="citation_reference" content="citation_title=Efficient Bayesian structural equation modeling in Stan;,citation_author=E. C. Merkle;,citation_author=E. Fitzsimmons;,citation_author=J. Uanhoro;,citation_author=B. Goodrich;,citation_publication_date=2021;,citation_cover_date=2021;,citation_year=2021;,citation_fulltext_html_url=https://www.jstatsoft.org/article/view/v100i06;,citation_issue=6;,citation_volume=100;,citation_journal_title=Journal of Statistical Software;">
<meta name="citation_reference" content="citation_title=blavaan: Bayesian structural equation models via parameter expansion;,citation_author=E. C. Merkle;,citation_author=Y. Rosseel;,citation_publication_date=2018;,citation_cover_date=2018;,citation_year=2018;,citation_fulltext_html_url=https://www.jstatsoft.org/article/view/v085i04;,citation_issue=4;,citation_volume=85;,citation_journal_title=Journal of Statistical Software;">
<meta name="citation_reference" content="citation_title=A study of factor analysis:&nbsp;The stability of a bi-factor solution;,citation_author=K. J. Holzinger;,citation_author=F. A. Swineford;,citation_publication_date=1939;,citation_cover_date=1939;,citation_year=1939;,citation_series_title=Supplementary educational monograph;">
<meta name="citation_reference" content="citation_title=Analysis of multivariate probit models;,citation_author=S. Chib;,citation_author=E. Greenberg;,citation_publication_date=1998;,citation_cover_date=1998;,citation_year=1998;,citation_volume=85;,citation_journal_title=Biometrika;">
<meta name="citation_reference" content="citation_title=Bayesian comparison of latent variable models: Conditional versus marginal likelihoods;,citation_author=E. C. Merkle;,citation_author=D. Furr;,citation_author=S. Rabe-Hesketh;,citation_publication_date=2019;,citation_cover_date=2019;,citation_year=2019;,citation_fulltext_html_url=https://arxiv.org/abs/1802.04452;,citation_volume=84;,citation_journal_title=Psychometrika;">
<meta name="citation_reference" content="citation_title=tmvnsim: Truncated multivariate normal simulation;,citation_author=Samsiddhi Bhattacjarjee;,citation_publication_date=2016;,citation_cover_date=2016;,citation_year=2016;,citation_fulltext_html_url=https://CRAN.R-project.org/package=tmvnsim;">
<meta name="citation_reference" content="citation_title=The normal law under linear restrictions: Simulation and estimation via minimax tilting;,citation_author=Z. I. Botev;,citation_publication_date=2017;,citation_cover_date=2017;,citation_year=2017;,citation_issue=1;,citation_doi=https://doi.org/10.1111/rssb.12162;,citation_volume=79;,citation_journal_title=Journal of the Royal Statistical Society: Series B;">
<meta name="citation_reference" content="citation_title=TruncatedNormal: Truncated multivariate normal and student distributions;,citation_author=Zdravko Botev;,citation_author=Leo Belzile;,citation_publication_date=2021;,citation_cover_date=2021;,citation_year=2021;,citation_fulltext_html_url=https://CRAN.R-project.org/package=TruncatedNormal;">
<meta name="citation_reference" content="citation_title=Advances in Bayesian model fit evaluation for structural equation models;,citation_author=Tihomir Asparouhov;,citation_author=Bengt Muthén;,citation_publication_date=2021;,citation_cover_date=2021;,citation_year=2021;,citation_issue=1;,citation_doi=10.1080/10705511.2020.1764360;,citation_volume=28;,citation_journal_title=Structural Equation Modeling: A Multidisciplinary Journal;">
<meta name="citation_reference" content="citation_title=The bhsdtr package: A general-purpose method of Bayesian inference for signal detection theory models;,citation_author=B. Paulewicz;,citation_author=A. Blaut;,citation_publication_date=2020;,citation_cover_date=2020;,citation_year=2020;,citation_volume=52;,citation_journal_title=Behavior Research Methods;">
<meta name="citation_reference" content="citation_title=Bayesplot: Plotting for bayesian models;,citation_author=Jonah Gabry;,citation_author=Tristan Mahr;,citation_publication_date=2021;,citation_cover_date=2021;,citation_year=2021;,citation_fulltext_html_url=https://mc-stan.org/bayesplot/;">
<meta name="citation_reference" content="citation_title=Loo: Efficient leave-one-out cross-validation and WAIC for bayesian models;,citation_author=Aki Vehtari;,citation_author=Jonah Gabry;,citation_author=Mans Magnusson;,citation_author=Yuling Yao;,citation_author=Paul-Christian Bürkner;,citation_author=Topi Paananen;,citation_author=Andrew Gelman;,citation_publication_date=2020;,citation_cover_date=2020;,citation_year=2020;,citation_fulltext_html_url=https://mc-stan.org/loo/;">
<meta name="citation_reference" content="citation_title=Bayesian analysis of binary and polychotomous response data;,citation_author=James H. Albert;,citation_author=Siddhartha Chib;,citation_publication_date=1993;,citation_cover_date=1993;,citation_year=1993;,citation_issue=422;,citation_volume=88;,citation_journal_title=Journal of the American Statistical Association;">
<meta name="citation_reference" content="citation_title=Adapting Fit Indices for Bayesian Structural Equation Modeling: Comparison to Maximum Likelihood;,citation_author=Mauricio Garnier-Villarreal;,citation_author=Terrence D Jorgensen;,citation_publication_date=2020;,citation_cover_date=2020;,citation_year=2020;,citation_issue=1;,citation_doi=dx.doi.org/10.1037/met0000224;,citation_volume=25;,citation_journal_title=Psychological Methods;">
<meta name="citation_reference" content="citation_title=Numerical computation of the multivariate normal probabilities;,citation_author=A. Genz;,citation_publication_date=1992;,citation_cover_date=1992;,citation_year=1992;,citation_volume=1;,citation_journal_title=Journal of Computational and Graphical Statistics;">
<meta name="citation_reference" content="citation_title=The R package mnormt: The multivariate normal and t distributions (version 2.0.2);,citation_author=A. Azzalini;,citation_author=A. Genz;,citation_publication_date=2020;,citation_cover_date=2020;,citation_year=2020;,citation_fulltext_html_url=http://azzalini.stat.unipd.it/SW/Pkg-mnormt/;">
<meta name="citation_reference" content="citation_title=mvtnorm: Multivariate normal and t distributions;,citation_author=A. Genz;,citation_author=F. Bretz;,citation_author=T. Miwa;,citation_author=X. Mi;,citation_author=F. Leisch;,citation_author=F. Scheipl;,citation_author=T. Hothorn;,citation_publication_date=2021;,citation_cover_date=2021;,citation_year=2021;,citation_fulltext_html_url=https://CRAN.R-project.org/package=mvtnorm;">
<meta name="citation_reference" content="citation_title=tlrmvnmvt: Computing high-dimensional multivariate normal and Student-t probabilities with low-rank methods in R;,citation_author=Jian Cao;,citation_author=Marc G. Genton;,citation_author=David E. Keyes;,citation_author=George M. Turkiyyah;,citation_publication_date=2022;,citation_cover_date=2022;,citation_year=2022;,citation_issue=4;,citation_doi=10.18637/jss.v101.i04;,citation_volume=101;,citation_journal_title=Journal of Statistical Software;">
<meta name="citation_reference" content="citation_title=Model Modification in Covariance Structure Analysis: Application of the Expected Parameter Change Statistic;,citation_author=David Kaplan;,citation_publication_date=1989;,citation_cover_date=1989;,citation_year=1989;,citation_fulltext_html_url=http://www.tandfonline.com/doi/abs/10.1207/s15327906mbr2403_2;,citation_issue=3;,citation_doi=10.1207/s15327906mbr2403_2;,citation_issn=0027-3171, 1532-7906;,citation_volume=24;,citation_journal_title=Multivariate Behavioral Research;">
<meta name="citation_reference" content="citation_title=Fit Indexes, Lagrange Multipliers, Constraint Changes and Incomplete Data in Structural Models;,citation_author=P. M. Bentler;,citation_publication_date=1990;,citation_cover_date=1990;,citation_year=1990;,citation_fulltext_html_url=http://www.tandfonline.com/doi/abs/10.1207/s15327906mbr2502_3;,citation_issue=2;,citation_doi=10.1207/s15327906mbr2502_3;,citation_issn=0027-3171, 1532-7906;,citation_volume=25;,citation_journal_title=Multivariate Behavioral Research;">
<meta name="citation_reference" content="citation_title=Using the Modification Index and Standardized Expected Parameter Change for Model Modification;,citation_author=Tiffany A. Whittaker;,citation_publication_date=2012;,citation_cover_date=2012;,citation_year=2012;,citation_fulltext_html_url=http://www.tandfonline.com/doi/abs/10.1080/00220973.2010.531299;,citation_issue=1;,citation_doi=10.1080/00220973.2010.531299;,citation_issn=0022-0973, 1940-0683;,citation_volume=80;,citation_journal_title=The Journal of Experimental Education;">
<meta name="citation_reference" content="citation_title=Opaque prior distributions in bayesian latent variable models;,citation_author=Edgar C. Merkle;,citation_author=Oludare Ariyo;,citation_author=Sonja D. Winter;,citation_author=Mauricio Garnier-Villarreal;,citation_publication_date=2023;,citation_cover_date=2023;,citation_year=2023;,citation_fulltext_html_url=https://arxiv.org/abs/2301.08667;">
<meta name="citation_reference" content="citation_title=Visualization in Bayesian Workflow;,citation_author=Jonah Gabry;,citation_author=Daniel Simpson;,citation_author=Aki Vehtari;,citation_author=Michael Betancourt;,citation_author=Andrew Gelman;,citation_publication_date=2019-01;,citation_cover_date=2019-01;,citation_year=2019;,citation_fulltext_html_url=https://doi.org/10.1111/rssa.12378;,citation_issue=2;,citation_doi=10.1111/rssa.12378;,citation_volume=182;,citation_journal_title=Journal of the Royal Statistical Society Series A: Statistics in Society;">
<meta name="citation_reference" content="citation_title=Bayesian Data Analysis, Third Edition (Chapman &amp;amp;amp; Hall/CRC Texts in Statistical Science);,citation_author=Andrew Gelman;,citation_author=John Carlin;,citation_author=Hal Stern;,citation_author=David Dunson;,citation_author=Aki Vehtari;,citation_author=Donald Rubin;,citation_publication_date=2014-11;,citation_cover_date=2014-11;,citation_year=2014;,citation_isbn=1-4398-4095-4;">
<meta name="citation_reference" content="citation_title=Bayesian structural equation modeling: A more flexible representation of substantive theory.;,citation_author=Bengt Muthén;,citation_author=Tihomir Asparouhov;,citation_publication_date=2012;,citation_cover_date=2012;,citation_year=2012;,citation_issue=3;,citation_doi=10.1037/a0026802;,citation_volume=17;,citation_journal_title=Psychological Methods;">
<meta name="citation_reference" content="citation_title=Small-variance priors can prevent detecting important misspecifications in Bayesian confirmatory factor analysis;,citation_author=Terrence D Jorgensen;,citation_author=Mauricio Garnier-Villarreal;,citation_author=Sunthud Pornprasertmanit;,citation_author=Jaehoon Lee;,citation_editor=Marie Wiberg;,citation_editor=Steven Culpepper;,citation_editor=Rianne Janssen;,citation_editor=Jorge González;,citation_editor=Dylan Molenaar;,citation_publication_date=2019;,citation_cover_date=2019;,citation_year=2019;,citation_doi=10.1007/978-3-030-01310-3_23;,citation_isbn=2194-1009;,citation_volume=265;,citation_inbook_title=Quantitative psychology: The 83rd annual meeting of the Psychometric Society, New York, NY, 2018;,citation_series_title=Springer Proceedings in Mathematics &amp;amp;amp; Statistics;">
<meta name="citation_reference" content="citation_title=Indices of Effect Existence and Significance in the Bayesian Framework;,citation_author=Dominique Makowski;,citation_author=Mattan S. Ben-Shachar;,citation_author=S. H. Annabel Chen;,citation_author=Daniel Lüdecke;,citation_publication_date=2019;,citation_cover_date=2019;,citation_year=2019;,citation_fulltext_html_url=https://www.frontiersin.org/article/10.3389/fpsyg.2019.02767/full;,citation_doi=10.3389/fpsyg.2019.02767;,citation_issn=1664-1078;,citation_volume=10;,citation_journal_title=Frontiers in Psychology;">
<meta name="citation_reference" content="citation_title=Structural Equations with Latent Variables;,citation_author=Kenneth A Bollen;,citation_publication_date=1989;,citation_cover_date=1989;,citation_year=1989;,citation_isbn=0-471-01171-1;,citation_series_title=Wiley series in probability and mathematical statistics;">
<meta name="citation_reference" content="citation_title=brms: An R package for Bayesian multilevel models using Stan;,citation_author=Paul-Christian Bürkner;,citation_publication_date=2017;,citation_cover_date=2017;,citation_year=2017;,citation_issue=1;,citation_doi=10.18637/jss.v080.i01;,citation_volume=80;,citation_journal_title=Journal of Statistical Software;">
<meta name="citation_reference" content="citation_title=Statistical rethinking: A Bayesian course with examples in R and Stan;,citation_author=Richard McElreath;,citation_publication_date=2020;,citation_cover_date=2020;,citation_year=2020;,citation_isbn=978-0-367-13991-9;,citation_series_title=CRC texts in statistical science;">
<meta name="citation_reference" content="citation_title=The Bayesian New Statistics: Hypothesis testing, estimation, meta-analysis, and power analysis from a Bayesian perspective;,citation_author=John K. Kruschke;,citation_author=Torrin M. Liddell;,citation_publication_date=2018-02;,citation_cover_date=2018-02;,citation_year=2018;,citation_fulltext_html_url=http://link.springer.com/10.3758/s13423-016-1221-4;,citation_issue=1;,citation_doi=10.3758/s13423-016-1221-4;,citation_issn=1069-9384, 1531-5320;,citation_volume=25;,citation_journal_title=Psychonomic Bulletin &amp;amp;amp; Review;">
<meta name="citation_reference" content="citation_title=Rank-Normalization, Folding, and Localization: An Improved \widehat{R} for Assessing Convergence of MCMC (with Discussion);,citation_author=Aki Vehtari;,citation_author=Andrew Gelman;,citation_author=Daniel Simpson;,citation_author=Bob Carpenter;,citation_author=Paul-Christian Bürkner;,citation_publication_date=2021;,citation_cover_date=2021;,citation_year=2021;,citation_fulltext_html_url=https://doi.org/10.1214/20-BA1221;,citation_issue=2;,citation_doi=10.1214/20-BA1221;,citation_volume=16;,citation_journal_title=Bayesian Analysis;,citation_publisher=International Society for Bayesian Analysis;">
<meta name="citation_reference" content="citation_title=Asymptotic equivalence of bayes cross validation and widely applicable information criterion in singular learning theory;,citation_author=Sumio Watanabe;,citation_publication_date=2010;,citation_cover_date=2010;,citation_year=2010;,citation_volume=11;,citation_journal_title=Journal of Machine Learning Research;">
<meta name="citation_reference" content="citation_title=Practical Bayesian model evaluation using leave-one-out cross-validation and WAIC;,citation_author=Aki Vehtari;,citation_author=Andrew Gelman;,citation_author=Jonah Gabry;,citation_publication_date=2017;,citation_cover_date=2017;,citation_year=2017;,citation_issue=5;,citation_doi=10.1007/s11222-016-9696-4;,citation_volume=27;,citation_journal_title=Statistics and Computing;">
<meta name="citation_reference" content="citation_title=A review of issues about null hypothesis Bayesian testing.;,citation_author=Jorge N. Tendeiro;,citation_author=Henk A. L. Kiers;,citation_publication_date=2019-12;,citation_cover_date=2019-12;,citation_year=2019;,citation_fulltext_html_url=http://doi.apa.org/getdoi.cfm?doi=10.1037/met0000221;,citation_issue=6;,citation_doi=10.1037/met0000221;,citation_issn=1939-1463, 1082-989X;,citation_volume=24;,citation_journal_title=Psychological Methods;">
<meta name="citation_reference" content="citation_title=Workflow techniques for the robust use of bayes factors.;,citation_author=Daniel J. Schad;,citation_author=Bruno Nicenboim;,citation_author=Paul-Christian Bürkner;,citation_author=Michael Betancourt;,citation_author=Shravan Vasishth;,citation_publication_date=2022-03;,citation_cover_date=2022-03;,citation_year=2022;,citation_fulltext_html_url=http://doi.apa.org/getdoi.cfm?doi=10.1037/met0000472;,citation_doi=10.1037/met0000472;,citation_issn=1939-1463, 1082-989X;,citation_journal_title=Psychological Methods;">
<meta name="citation_reference" content="citation_title=Evaluating the observed log-likelihood function in two-level structural equation modeling with missing data: From formulas to R code;,citation_author=Yves Rosseel;,citation_publication_date=2021;,citation_cover_date=2021;,citation_year=2021;,citation_issue=2;,citation_doi=10.3390/psych3020017;,citation_volume=3;,citation_journal_title=Psych;">
<meta name="citation_reference" content="citation_title=The targets R package: A dynamic Make-like function-oriented pipeline toolkit for reproducibility and high-performance computing;,citation_author=William Michael Landau;,citation_publication_date=2021;,citation_cover_date=2021;,citation_year=2021;,citation_fulltext_html_url=https://doi.org/10.21105/joss.02959;,citation_issue=57;,citation_volume=6;,citation_journal_title=Journal of Open Source Software;">
<meta name="citation_reference" content="citation_title=tarchetypes: Archetypes for targets;,citation_author=William Michael Landau;,citation_publication_date=2021;,citation_cover_date=2021;,citation_year=2021;">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Ed Merkle</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../publications.html"> 
<span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-case-studies" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Case Studies</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-case-studies">    
        <li>
    <a class="dropdown-item" href="../cs/ord_ic.html">
 <span class="dropdown-text">Ordinal likelihoods</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../cs/targets.html">
 <span class="dropdown-text">targets package</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../consult.html"> 
<span class="menu-text">Consulting</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://mastodon.sdf.org/@edgarmerkle"> <i class="bi bi-mastodon" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://bsky.app/profile/edgarmerkle.bsky.social"> <i class="bi bi-bluesky" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ecmerkle"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Adventures in ordinal model likelihoods</h1>
                  <div>
        <div class="description">
          <p>This case study provides information about computing (approximating) likelihoods of structural equation models with ordinal variables. We consider interactions between theoretical results and computational issues, and we also consider the influence of likelihood approximations on information criteria like WAIC. Finally, we discuss how <em>blavaan</em> handles related issues.</p>
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">statistics</div>
                <div class="quarto-category">multivariate probit models</div>
                <div class="quarto-category">structural equation models</div>
                <div class="quarto-category">R</div>
                <div class="quarto-category">blavaan</div>
              </div>
                  </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-heading">Affiliation</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author"><a href="https://ecmerkle.github.io">Edgar C. Merkle</a> <a href="https://orcid.org/0000-0001-7158-0653" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              <a href="https://psychology.missouri.edu/people/merkle">
              University of Missouri
              </a>
            </p>
        </div>
    </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">November 10, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#model-setup" id="toc-model-setup" class="nav-link" data-scroll-target="#model-setup">Model Setup</a></li>
  <li><a href="#model-likelihoods" id="toc-model-likelihoods" class="nav-link" data-scroll-target="#model-likelihoods">Model Likelihoods</a></li>
  <li><a href="#approximating-the-distribution-of-y_i" id="toc-approximating-the-distribution-of-y_i" class="nav-link" data-scroll-target="#approximating-the-distribution-of-y_i">Approximating the Distribution of <span class="math inline">\(y_i\)</span></a></li>
  <li><a href="#likelihood-computations-in-blavaan" id="toc-likelihood-computations-in-blavaan" class="nav-link" data-scroll-target="#likelihood-computations-in-blavaan">Likelihood Computations in blavaan</a></li>
  <li><a href="#implications-for-information-criteria" id="toc-implications-for-information-criteria" class="nav-link" data-scroll-target="#implications-for-information-criteria">Implications for Information Criteria</a></li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions">Conclusions</a></li>
  <li><a href="#acknowledgment" id="toc-acknowledgment" class="nav-link" data-scroll-target="#acknowledgment">Acknowledgment</a></li>
  <li><a href="#license" id="toc-license" class="nav-link" data-scroll-target="#license">License</a></li>
  <li><a href="#computing-environment" id="toc-computing-environment" class="nav-link" data-scroll-target="#computing-environment">Computing Environment</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>This page contains information about computing (approximating) likelihoods of structural equation models with ordinal variables. We consider interactions between theoretical results and computational issues, and we also consider the influence of likelihood approximations on information criteria like WAIC. Finally, we discuss how <em>blavaan</em> handles related issues.</p>
<section id="introduction" class="level3">
<h3 class="anchored" data-anchor-id="introduction">Introduction</h3>
<p>SEMs with ordinal variables can have at least two types of latent variables. The first type, which is a hallmark of SEM, represents unobserved traits of the individuals (of the “clusters”) in our dataset. These latent variables are very similar to random effects in mixed models, and they are sometimes exactly the same as random effects in mixed models.</p>
<p>The second type of latent variable involves the fact that we have ordinal observed data. For these models, we typically assume continuous variables underlying the ordinal data, which are chopped to yield ordered categories. But these continuous variables are unobserved, so that they can be called latent variables. The famous data augmentation algorithms described by <span class="citation" data-cites="albchi93">Albert and Chib (<a href="#ref-albchi93" role="doc-biblioref">1993</a>)</span> and <span class="citation" data-cites="chigre98">Chib and Greenberg (<a href="#ref-chigre98" role="doc-biblioref">1998</a>)</span> involve generating these continuous variables as though they are extra parameters, which makes it easier to estimate the rest of the model.</p>
<p>When we define a model likelihood, we often opt to integrate out the latent variables so that we no longer have to worry about estimating them (the integration is also known as <em>marginalizing</em> or <em>averaging over</em> the latent variables). This means that a single model can have many likelihoods associated with it, depending on what we integrate out. For a single SEM with ordinal data, there are at least four likelihoods that may be used. While all four likelihoods would lead to the same parameter estimates, they could yield different information criteria, posterior predictive checks, and model fit assessments <span class="citation" data-cites="merfur19">(see <a href="#ref-merfur19" role="doc-biblioref">Merkle, Furr, and Rabe-Hesketh 2019</a> for related discussion)</span>. The goal of this document is to outline computation of various likelihoods, and to consider their involvement in information criterion computations.</p>
</section>
<section id="model-setup" class="level3">
<h3 class="anchored" data-anchor-id="model-setup">Model Setup</h3>
<p>We assume data vectors <span class="math inline">\(\boldsymbol{y}_i\)</span> of length <span class="math inline">\(p\)</span>, <span class="math inline">\(i=1,\ldots,n\)</span>, where all <span class="math inline">\(p\)</span> variables are ordinal. As mentioned above, the typical SEM assumes continuous, latent data vectors <span class="math inline">\(\boldsymbol{y}^\ast_i\)</span> underlying the ordinal data. The model then goes on these continuous data vectors. The LISREL-style model formulation is <span class="math display">\[\begin{align}
    \boldsymbol{y}^\ast_i &amp;= \boldsymbol{\nu} + \boldsymbol{\Lambda} \boldsymbol{\eta}_i + \boldsymbol{\epsilon}_i \\
    \boldsymbol{\eta}_i &amp;= \boldsymbol{\alpha} + \boldsymbol{B \eta}_i + \boldsymbol{\zeta}_i,
\end{align}\]</span> where the residual vectors <span class="math inline">\(\boldsymbol{\epsilon}_i\)</span> and <span class="math inline">\(\boldsymbol{\zeta}_i\)</span> are assumed to be multivariate normal with mean <span class="math inline">\(\boldsymbol{0}\)</span>. For models with ordinal variables, the covariance matrix associated with <span class="math inline">\(\boldsymbol{\epsilon}_i\)</span> is typically diagonal. The <span class="math inline">\(\boldsymbol{\eta}_i\)</span> are the traditional SEM latent variables (the “first type” that we discussed at the start of the document), and the remaining vectors and matrices contain model parameters.</p>
<p>To get back to the observed, ordinal data, we add threshold parameters <span class="math inline">\(\boldsymbol{\tau}\)</span> that chop the continuous variables. For example, in the case of an ordinal <span class="math inline">\(y_{ij}\)</span> with four categories, we would have <span class="math display">\[\begin{align*}
y_{ij} = 1 &amp;\text{ if }y^*_{ij} &lt; \tau_{j1} \\
y_{ij} = 2 &amp;\text{ if }\tau_{j1} &lt;\ y^*_{ij} &lt; \tau_{j2} \\
y_{ij} = 3 &amp;\text{ if }\tau_{j2} &lt;\ y^*_{ij} &lt; \tau_{j3} \\
y_{ij} = 4 &amp;\text{ if }y_{ij}^* &gt;\ \tau_{j3},
\end{align*}\]</span> where <span class="math inline">\(\tau_{j1} &lt; \tau_{j2} &lt; \tau_{j3}\)</span>.</p>
</section>
<section id="model-likelihoods" class="level3">
<h3 class="anchored" data-anchor-id="model-likelihoods">Model Likelihoods</h3>
<p>If each element of <span class="math inline">\(\boldsymbol{y}_i\)</span> were independent of the other elements, it would be simple to write the model likelihood as a product of multinomial distributions (where the multinomial <span class="math inline">\(n\)</span> parameter is fixed to 1, sometimes called a <em>categorical</em> distribution). But the elements of <span class="math inline">\(\boldsymbol{y}_i\)</span> are typically not independent, so we have to do something extra to obtain the model likelihood. The specific “something extra” that we choose leads to different likelihoods. Here are some possibilities:</p>
<ol type="1">
<li>Sample the traditional latent variables <span class="math inline">\(\boldsymbol{\eta}_i\)</span> during MCMC. Conditioned on these latent variables, the elements of <span class="math inline">\(\boldsymbol{y}_i\)</span> are usually independent, so that computation of the (conditional) likelihood is easy. It is a product of multinomials.</li>
<li>Approximate the joint likelihood of all elements of <span class="math inline">\(\boldsymbol{y}_i\)</span>. This involves integrating over <span class="math inline">\(\boldsymbol{y}^\ast_{i}\)</span>, which is multivariate normal. The integration limits are determined by the <span class="math inline">\(\boldsymbol{\tau}\)</span> parameters, so it amounts to repeatedly evaluating the cumulative distribution function of a multivariate normal. It is a difficult problem but has received a good amount of attention in the literature.</li>
<li>Focus on the distribution of the <span class="math inline">\(\boldsymbol{y}^\ast_i\)</span> instead of the observed <span class="math inline">\(\boldsymbol{y}_i\)</span>. This is a multivariate normal distribution. Further, if we sample the <span class="math inline">\(\boldsymbol{\eta}_i\)</span> during MCMC, then this is a series of univariate normal distributions.</li>
</ol>
<p>Traditional MCMC algorithms for ordinal SEM take the first approach, sampling latent variables alongside other parameters. This can be problematic for large <span class="math inline">\(n\)</span>, because the number of latent variables increases with <span class="math inline">\(n\)</span> and leads to slow sampling. Further, the “number of parameters increases with sample size” issue means that some theoretical, asymptotic properties of information criteria are no longer guaranteed <span class="citation" data-cites="merfur19">(see <a href="#ref-merfur19" role="doc-biblioref">Merkle, Furr, and Rabe-Hesketh 2019</a> for more detail)</span>. For these reasons, <em>blavaan</em> avoids sampling the <span class="math inline">\(\boldsymbol{\eta}_i\)</span> during model estimation. See <span class="citation" data-cites="merfit21">Merkle et al. (<a href="#ref-merfit21" role="doc-biblioref">2021</a>)</span> for details involving models with continuous data.</p>
<p>The <em>blavaan</em> approach to estimating these models (currently) involves the third option. Similar to <span class="citation" data-cites="chigre98">Chib and Greenberg (<a href="#ref-chigre98" role="doc-biblioref">1998</a>)</span>, we generate the continuous <span class="math inline">\(\boldsymbol{y}^\ast_i\)</span> underlying the ordinal observed variables and then work with a multivariate normal likelihood. And we avoid sampling the <span class="math inline">\(\boldsymbol{\eta}_i\)</span> during model estimation (though they can be sampled as a by-product of model estimation).</p>
<p>Even though we use the <span class="math inline">\(\boldsymbol{y}^\ast_i\)</span> for estimation, it is not good to use the distribution of <span class="math inline">\(\boldsymbol{y}^\ast_i\)</span> for information criteria and posterior predictive checks. This is because the <span class="math inline">\(\boldsymbol{y}^\ast_i\)</span> are basically extra parameters, so they influence effective number of parameter computations for DIC, WAIC, PSIS-LOO, and related metrics. (Side note: if you see an effective number of parameters value that is larger than <span class="math inline">\(n\)</span>, it is likely that a suboptimal information criterion is being used.) Therefore, for likelihood-based model summaries and information criteria, we carry out the approximation described in #2 <em>after MCMC estimation</em>. This leads to longer post-estimation computation times, but we believe they are the best default metrics to use.</p>
</section>
<section id="approximating-the-distribution-of-y_i" class="level3">
<h3 class="anchored" data-anchor-id="approximating-the-distribution-of-y_i">Approximating the Distribution of <span class="math inline">\(y_i\)</span></h3>
<p>The distribution of <span class="math inline">\(\boldsymbol{y}_i\)</span> requires us to integrate the multivariate normal distribution across limits determined by the observed data and the <span class="math inline">\(\boldsymbol{\tau}\)</span>, which is a computationally expensive activity. And, for metrics like WAIC and PSIS-LOO, we must compute this density for each case <span class="math inline">\(i\)</span> (or for each response pattern), for each posterior sample. So we find ourselves in a familiar situation where we must trade off computational accuracy with computational speed. There exist multiple options for approximating the integral, and we want to know what option will provide the most accurate approximation the fastest. The options we consider are</p>
<ol type="1">
<li><p>Adapted Gauss-Hermite Quadrature: Because we are carrying out the computations after model estimation, we can have access to samples of the latent variables <span class="math inline">\(\boldsymbol{\eta}_i\)</span>. This allows us to make informed choices about quadrature points for each case <span class="math inline">\(i\)</span> <span class="citation" data-cites="merfur19">(again see <a href="#ref-merfur19" role="doc-biblioref">Merkle, Furr, and Rabe-Hesketh 2019</a>)</span> so that the procedure is “already adapted” instead of “adaptive”. As the number of quadrature points increases, adaptive Gauss-Hermite quadrature is often treated as the gold standard approximation. But large numbers of quadrature points are computationally expensive.</p></li>
<li><p>Importance Sampling of <span class="math inline">\(\boldsymbol{y}^\ast_i\)</span>: In R, there exist importance sampling algorithms (notably, the GHK algorithm) for evaluating the multivariate normal CDF. To do this, <em>blavaan</em> uses the <code>tmvnsim()</code> function from the <em>tmvnsim</em> package. The function generates samples from the distribution of <span class="math inline">\(\boldsymbol{y}^\ast_i\)</span> and, as a by-product, produces an approximation of the likelihood of <span class="math inline">\(\boldsymbol{y}_i\)</span>. Larger numbers of importance samples lead to more accurate approximations, similarly to larger numbers of quadrature points.</p></li>
<li><p>Adaptive Subregion Integration: This is a Fortran program provided by Genz <span class="citation" data-cites="gen92">(e.g., <a href="#ref-gen92" role="doc-biblioref">Genz 1992</a>)</span> and included in the R package <em>mnormt</em> <span class="citation" data-cites="azzgen20">(<a href="#ref-azzgen20" role="doc-biblioref">Azzalini and Genz 2020</a>)</span> via the <code>sadmvn()</code> function. It involves separately approximating subregions of the domain of integration, then performing extra approximations in subregions with high error.</p></li>
</ol>
<!--
4. Minimax Tilting: A procedure introduced by @bot17 that is especially applicable to high-dimensional multivariate normals (it works in places where other procedures do not). It involves an optimization step to do exponential tipping on the distribution, followed by a Monte Carlo algorithm that seems similar to importance sampling.

5. tlrmvnmvt package: It uses a sparse Cholesky decomposition that allows us to work with submatrices of smaller dimension than the original multivariate normal. It appears to be fast and accurate for multivariate normals of over 1,000 dimensions.
-->
<p>For almost all traditional SEMs, the dimension of <span class="math inline">\(\boldsymbol{\eta}_i\)</span> is less than the dimension of the <span class="math inline">\(\boldsymbol{y}^\ast_i\)</span>, suggesting that quadrature is advantageous (because quadrature integrates over <span class="math inline">\(\eta\)</span>, and others integrate over <span class="math inline">\(y^\ast\)</span>). But the quadrature method must be designed specifically for SEM, whereas evaluation of the multivariate normal CDF is a general problem with many efficient, existing software implementations. We carry out some relevant analyses below, but we first illustrate the different computational methods that we can obtain from <em>blavaan</em>.</p>
</section>
<section id="likelihood-computations-in-blavaan" class="level3">
<h3 class="anchored" data-anchor-id="likelihood-computations-in-blavaan">Likelihood Computations in blavaan</h3>
<p>We now illustrate subregion integration, importance sampling, and adapted quadrature in <em>blavaan</em>. We focus on evaluating likelihoods of the <span class="math inline">\(\boldsymbol{y}_i\)</span>; the likelihoods of <span class="math inline">\(\boldsymbol{y}^\ast_i\)</span> are simple multivariate normals.</p>
<p>The chunk below involves the usual 3-factor, 9 variable CFA example. When the observed variables are ordinal, we might call it an item factor analysis model. Using <em>lavaan</em>, we specify the model and generate fake data via</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>HS.model <span class="ot">&lt;-</span> <span class="st">' visual  =~ x1 + x2 + x3</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="st">              textual =~ x4 + x5 + x6</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="st">              speed   =~ x7 + x8 + x9 '</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="do">## continuous data:</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>dcont <span class="ot">&lt;-</span> <span class="fu">simulateData</span>(HS.model, <span class="at">sample.nobs=</span><span class="dv">200</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="do">## chopped up to yield 3-category ordinal data</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="do">## (this is a custom function that appears in the Rmd):</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>Data <span class="ot">&lt;-</span> <span class="fu">makeord</span>(dcont, <span class="at">ncat =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we estimate the model in <em>blavaan</em> and specify <code>save.lvs = TRUE</code>. We need estimates of latent variables for some post-estimation computations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">bcfa</span>(HS.model, <span class="at">data=</span>Data, <span class="at">sample=</span><span class="dv">500</span>, <span class="at">burnin=</span><span class="dv">500</span>, <span class="at">ordered=</span><span class="cn">TRUE</span>, <span class="at">std.lv=</span><span class="cn">TRUE</span>,</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">save.lvs=</span><span class="cn">TRUE</span>, <span class="at">dp =</span> <span class="fu">dpriors</span>(<span class="at">lambda =</span> <span class="st">"normal(1,.5)"</span>), <span class="at">seed =</span> <span class="dv">123</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="conditional-log-likelihood" class="level4">
<h4 class="anchored" data-anchor-id="conditional-log-likelihood">Conditional Log-Likelihood</h4>
<p>From here, we need to use a few <em>blavaan</em> functions that are not exported (because we don’t expect users to routinely need them). We will extract the first posterior sample (including latent variables), then compute casewise likelihoods for that posterior sample. We start with likelihoods that are conditional on <span class="math inline">\(\boldsymbol{\eta}_i\)</span>, which are easier. Then we move to marginal likelihoods.</p>
<p>Conditional likelihoods can be computed using the non-exported function <code>get_ll()</code>, as below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="do">## all posterior samples</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>samps <span class="ot">&lt;-</span> <span class="fu">do.call</span>(<span class="st">"rbind"</span>, blavaan<span class="sc">:::</span><span class="fu">make_mcmc</span>(fit<span class="sc">@</span>external<span class="sc">$</span>mcmcout, fit<span class="sc">@</span>external<span class="sc">$</span>stanlvs))</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="do">## casewise, conditional (on eta) log-likelihood of the first posterior sample</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>cll1 <span class="ot">&lt;-</span> blavaan<span class="sc">:::</span><span class="fu">get_ll</span>(<span class="at">postsamp =</span> samps[<span class="dv">1</span>,], fit,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">casewise =</span> <span class="cn">TRUE</span>, <span class="at">conditional =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We show a little bit more about what is happening using the chunk below. We first arrange the posterior sample in model matrices. We then compute casewise log-likelihoods by taking advantage of the fact that the observed variables are independent conditioned on the latent variables. This allows us to compute response probabilities via a series of calls to <code>pnorm()</code>. Those response probabilities then enter into the likelihood on the last line.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="do">## create model matrices using the first posterior sample</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>lavmod <span class="ot">&lt;-</span> blavaan<span class="sc">:::</span><span class="fu">fill_params</span>(samps[<span class="dv">1</span>,], fit<span class="sc">@</span>Model, fit<span class="sc">@</span>ParTable)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="do">## vector of all latent variables</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>etasamps <span class="ot">&lt;-</span> samps[<span class="dv">1</span>,<span class="fu">grep</span>(<span class="st">"^eta"</span>, <span class="fu">colnames</span>(samps))]</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="do">## casewise log-likelihoods</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>mancll <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nobs</span>(fit))</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nobs</span>(fit)){</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="do">## conditional means</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  etas <span class="ot">&lt;-</span> etasamps[((i<span class="dv">-1</span>)<span class="sc">*</span><span class="dv">3</span> <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(i<span class="sc">*</span><span class="dv">3</span>)]</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  tmpmn <span class="ot">&lt;-</span> lavmod<span class="sc">@</span>GLIST<span class="sc">$</span>lambda <span class="sc">%*%</span> etas</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="do">## thresholds for observation ij</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  lot <span class="ot">&lt;-</span> hit <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>,<span class="dv">9</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>){</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    tmptau <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>, lavmod<span class="sc">@</span>GLIST<span class="sc">$</span>tau[((j<span class="dv">-1</span>)<span class="sc">*</span><span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(j<span class="sc">*</span><span class="dv">2</span>)], <span class="cn">Inf</span>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    lot[j] <span class="ot">&lt;-</span> tmptau[Data[i,j]]</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    hit[j] <span class="ot">&lt;-</span> tmptau[Data[i,j] <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  <span class="do">## log-likelihood</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  tmpcatprob <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(hit, <span class="at">mean =</span> tmpmn) <span class="sc">-</span> <span class="fu">pnorm</span>(lot, <span class="at">mean =</span> tmpmn)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  mancll[i] <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">dbinom</span>(<span class="dv">1</span>, <span class="at">size=</span><span class="dv">1</span>, <span class="at">prob=</span>tmpcatprob, <span class="at">log=</span><span class="cn">TRUE</span>))</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And the plot below confirms that these computations are the same as what was provided by <code>get_ll()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cll1, mancll, <span class="at">xlab=</span><span class="st">"get_ll()"</span>, <span class="at">ylab=</span><span class="st">"manual calculation"</span>); <span class="fu">abline</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ord_ic_files/figure-html/plcll-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="marginal-log-likelihood" class="level4">
<h4 class="anchored" data-anchor-id="marginal-log-likelihood">Marginal Log-Likelihood</h4>
<p>To approximate the marginal log-likelihood, <em>blavaan</em> currently has two built-in options: subregion adaptive integration (default) and importance sampling. To use importance sampling, users must supply the number of desired samples in the model estimation call (via <code>llnsamp</code>; see <a href="https://ecmerkle.github.io/blavaan/articles/ordinal.html">here</a> for details, which partially repeats what is stated here).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="do">## casewise, marginal log-likelihood of the first posterior sample</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="do">## using the Genz method</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>mll1 <span class="ot">&lt;-</span> blavaan<span class="sc">:::</span><span class="fu">get_ll</span>(<span class="at">postsamp =</span> samps[<span class="dv">1</span>,], fit, <span class="at">casewise =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="do">## casewise, marginal log-likelihood using importance sampling</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>fit<span class="sc">@</span>Options<span class="sc">$</span>llnsamp <span class="ot">&lt;-</span> <span class="dv">50</span>  <span class="do">## triggers use of importance sampling</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>iml1 <span class="ot">&lt;-</span> blavaan<span class="sc">:::</span><span class="fu">get_ll</span>(<span class="at">postsamp =</span> samps[<span class="dv">1</span>,], fit, <span class="at">casewise =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And the chunk below shows more about how these computations are done. We first obtain the model-implied mean vector and covariance matrix for the <span class="math inline">\(\boldsymbol{y}^\ast_i\)</span>. Then lower and upper bounds are determined by the observed data. Finally, these variables are sent to <code>sadmvn()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="do">## create model matrices using the first posterior sample</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>lavmod <span class="ot">&lt;-</span> blavaan<span class="sc">:::</span><span class="fu">fill_params</span>(samps[<span class="dv">1</span>,], fit<span class="sc">@</span>Model, fit<span class="sc">@</span>ParTable)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="do">## model-implied mean and cov matrix</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>impl <span class="ot">&lt;-</span> <span class="fu">lav_model_implied</span>(lavmod, <span class="at">delta =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="do">## casewise log-likelihoods</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>manmll <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nobs</span>(fit))</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nobs</span>(fit)){</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="do">## thresholds for observation ij</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  lot <span class="ot">&lt;-</span> hit <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>,<span class="dv">9</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>){</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    tmptau <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>, lavmod<span class="sc">@</span>GLIST<span class="sc">$</span>tau[((j<span class="dv">-1</span>)<span class="sc">*</span><span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(j<span class="sc">*</span><span class="dv">2</span>)], <span class="cn">Inf</span>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    lot[j] <span class="ot">&lt;-</span> tmptau[Data[i,j]]</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    hit[j] <span class="ot">&lt;-</span> tmptau[Data[i,j] <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="do">## log-likelihood via Genz method</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  tmpsamp <span class="ot">&lt;-</span> <span class="fu">sadmvn</span>(lot, hit, <span class="at">mean =</span> impl<span class="sc">$</span>mean[[<span class="dv">1</span>]], <span class="at">varcov =</span> impl<span class="sc">$</span>cov[[<span class="dv">1</span>]], <span class="at">abseps =</span> <span class="fl">1e-2</span>)</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  manmll[i] <span class="ot">&lt;-</span> <span class="fu">log</span>(tmpsamp)</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  <span class="do">## log-likelihood via tmvnsim</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>  <span class="do">## tmpsamp &lt;- tmvnsim(50, 9, lower = lot, upper = hit, means = impl$mean[[1]],</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>  <span class="do">##                    sigma = impl$cov[[1]])</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>  <span class="do">## manmll[i] &lt;- log( mean(tmpsamp$wts) )</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And the plot below confirms that we are obtaining the same values that we obtained via <em>blavaan</em>’s built-in computations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mll1, manmll, <span class="at">xlab=</span><span class="st">"get_ll()"</span>, <span class="at">ylab=</span><span class="st">"manual calculation"</span>); <span class="fu">abline</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ord_ic_files/figure-html/plmll-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can also use “adapted” quadrature to approximate the marginal likelihood. First, we use the estimated posterior means and covariances of the <span class="math inline">\(\boldsymbol{\eta}_i\)</span> to adapt the quadrature nodes and weights to each case <span class="math inline">\(i\)</span>. Then we repeatedly evaluate the conditional likelihood at each node. Finally, the marginal likelihood is a weighted sum of the conditional likelihoods. The code exists in <em>blavaan</em> to do this for certain models, but it is currently unused. It can be run as below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>qmll <span class="ot">&lt;-</span> blavaan<span class="sc">:::</span><span class="fu">adapted_ghq</span>(fit, <span class="at">ngq =</span> <span class="dv">5</span>, <span class="at">samprow =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This function is repeatedly evaluating the conditional likelihood that we used earlier (see the previous chunk involving <code>pnorm()</code> commands), then averaging over the evaluations. The quadrature method defines the latent variable values at which we evaluate the conditional likelihood, and it defines the weights involved in the (weighted) average. The plot below shows that it yields results that are similar to what we obtained from <code>get_ll()</code> (which used the Genz method).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mll1, qmll, <span class="at">xlab=</span><span class="st">"get_ll()"</span>, <span class="at">ylab=</span><span class="st">"genz"</span>); <span class="fu">abline</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ord_ic_files/figure-html/impquad-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="implications-for-information-criteria" class="level3">
<h3 class="anchored" data-anchor-id="implications-for-information-criteria">Implications for Information Criteria</h3>
<p>All of the above illustrations involved casewise likelihoods for a single posterior sample. If we are to obtain information criteria like WAIC and PSIS-LOO, we need to compute these casewise likelihoods for <em>each</em> posterior sample. This is computationally heavy, especially for information criteria that involve the marginal likelihood (which is the best general option). Say that we have a dataset of 300 individuals, and we save 1,000 posterior samples for each of three chains. If it takes one second to evaluate each posterior sample, then it will take 50 minutes to evaluate all 3,000 posterior samples. It is clear that we need to be as economical as possible, while still doing accurate computations.</p>
<p>We want to know how crude our marginal likelihood approximations can be without sacrificing accuracy. So we approximate the likelihood in various ways and compare the values of the resulting information criteria. Our gold standard is the adapted quadrature method with a large number of quadrature points. For the particular factor analysis model that we consider here, 7 points per dimension was sufficient (further numbers of points left the log-likelihoods virtually unchanged). We compared the gold standard to importance sampling with 5, 10, 20, and 50 samples per case, and to adapted quadrature with 1, 2, and 4 points per dimension.</p>
<div class="cell" data-hash="ord_ic_cache/html/gold_fadacee8b88c598afebcb22bf201a1c8">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="do">## gold standard</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>gsll <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">future_sapply</span>(<span class="at">X =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(samps),</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">FUN =</span> <span class="cf">function</span>(i) blavaan<span class="sc">:::</span><span class="fu">adapted_ghq</span>(fit, <span class="at">ngq =</span> <span class="dv">7</span>, <span class="at">samprow =</span> i), <span class="at">future.seed =</span> <span class="cn">TRUE</span>))</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>gsloo <span class="ot">&lt;-</span> <span class="fu">loo</span>(gsll, <span class="at">r_eff =</span> <span class="fu">relative_eff</span>(gsll, <span class="at">chain_id =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">each =</span> <span class="fu">nrow</span>(samps)<span class="sc">/</span><span class="dv">3</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="ord_ic_cache/html/iccomps_3fa90365fe249df7206738736a205780">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>impsamps <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">50</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>qpts <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>isll <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="fu">length</span>(impsamps))</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>isloo <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="fu">length</span>(impsamps))</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>aqll <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="fu">length</span>(qpts))</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>aqloo <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="fu">length</span>(qpts))</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>fit<span class="sc">@</span>Options<span class="sc">$</span>llnsamp <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="do">## genz subregion integration</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>gzl1 <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">future_sapply</span>(<span class="at">X =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(samps),</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>                        <span class="at">FUN =</span> <span class="cf">function</span>(j) blavaan<span class="sc">:::</span><span class="fu">get_ll</span>(<span class="at">postsamp =</span> samps[j,], fit, <span class="at">casewise =</span> <span class="cn">TRUE</span>), <span class="at">future.seed =</span> <span class="cn">TRUE</span>))</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>gzloo <span class="ot">&lt;-</span> <span class="fu">loo</span>(gzl1, <span class="at">r_eff =</span> <span class="fu">relative_eff</span>(gzl1, <span class="at">chain_id =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">each =</span> <span class="fu">nrow</span>(samps)<span class="sc">/</span><span class="dv">3</span>)))</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="do">## importance sampling</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(impsamps)) {</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  fit<span class="sc">@</span>Options<span class="sc">$</span>llnsamp <span class="ot">&lt;-</span> impsamps[i]  </span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  isll[[i]] <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">future_sapply</span>(<span class="at">X =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(samps),</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>                               <span class="at">FUN =</span> <span class="cf">function</span>(j) blavaan<span class="sc">:::</span><span class="fu">get_ll</span>(<span class="at">postsamp =</span> samps[j,], fit, <span class="at">casewise =</span> <span class="cn">TRUE</span>), <span class="at">future.seed =</span> <span class="cn">TRUE</span>))</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>  isloo[[i]] <span class="ot">&lt;-</span> <span class="fu">loo</span>(isll[[i]], <span class="at">r_eff =</span> <span class="fu">relative_eff</span>(isll[[i]], <span class="at">chain_id =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">each =</span> <span class="fu">nrow</span>(samps)<span class="sc">/</span><span class="dv">3</span>)))</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="do">## adapted quadrature</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(qpts)) {</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>  aqll[[i]] <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">future_sapply</span>(<span class="at">X =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(samps),</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>                               <span class="at">FUN =</span> <span class="cf">function</span>(j) blavaan<span class="sc">:::</span><span class="fu">adapted_ghq</span>(fit, <span class="at">ngq =</span> qpts[i],</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>                                                                       <span class="at">samprow =</span> j), <span class="at">future.seed =</span> <span class="cn">TRUE</span>))</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>  aqloo[[i]] <span class="ot">&lt;-</span> <span class="fu">loo</span>(aqll[[i]], <span class="at">r_eff =</span> <span class="fu">relative_eff</span>(aqll[[i]], <span class="at">chain_id =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">each =</span> <span class="fu">nrow</span>(samps)<span class="sc">/</span><span class="dv">3</span>)))</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The computed PSIS-LOO estimates are shown below, with the left panel being importance sampling results and the right panel being adapted quadrature results. The dashed line is the gold standard value, and the shading indicates 1 standard error above and below the PSIS-LOO estimates. We see that all estimates are within one standard error of the gold standard, providing possible evidence that we can get by with crude integral approximations.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ord_ic_files/figure-html/gr1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The next graph, however, brings this evidence into question. This graph is arranged in the same way as the previous one, but it shows effective number of parameter estimates instead of the full PSIS-LOO estimates. We see that, for few importance samples and few quadrature points, the effective number of parameters is systematically over-estimated. We believe that this is because effective number of parameters is based on the variability of log-likelihoods, and the noise from crude integral approximations contributes extra variability. This suggests that, with crude approximations, the models are judged as being more flexible than they actually are.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ord_ic_files/figure-html/gr2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Finally, the results of the Genz method (not shown) are practically equal to the results of the gold standard quadrature method, matching to one decimal point.</p>
</section>
<section id="conclusions" class="level2">
<h2 class="anchored" data-anchor-id="conclusions">Conclusions</h2>
<p>For the model considered here, the adaptive subregion integration method was as good as the gold standard quadrature method and also considerably faster. This is counterintuitive because the quadrature method was integrating over three dimensions, while the subregion method was integrating over nine dimensions. The speed difference probably reflects the methods’ implementations. The quadrature method was coded in R specifically for <em>blavaan</em> models and could be further optimized, whereas the adaptive integration method is coded in Fortran, works for general multivariate normal distributions, and has been developed over decades.</p>
<p>A limitation of the adaptive subregion integration provided by <em>mnormt</em> is that it cannot handle integration dimensions above 20. So, if your model has over 20 ordinal variables, it is not possible to use the <code>sadmvn()</code> function. In that case, <em>blavaan</em> will revert to importance sampling, which will be slower and potentially less precise (as shown in the example here). An alternative option involves moving to the <code>pmvnorm()</code> function from <em>mvtnorm</em> <span class="citation" data-cites="genhot21">(<a href="#ref-genhot21" role="doc-biblioref">Genz et al. 2021</a>)</span>, which may handle higher dimensions in some cases. This function is slower than <code>sadmvn()</code> at lower dimensions, though, and we have not compared it to importance sampling at this time. Another option is the tilting method of integrating the multivariate normal, which is found in the <em>TruncatedNormal</em> package <span class="citation" data-cites="tn21">(<a href="#ref-tn21" role="doc-biblioref">Botev and Belzile 2021</a>)</span>. Yet another option is the <em>tlrmvnmvt</em> package <span class="citation" data-cites="tlrmvnmvt">(<a href="#ref-tlrmvnmvt" role="doc-biblioref">Cao et al. 2022</a>)</span>, which includes a fast Genz method that appears to work for higher dimensions than the other packages. These will be further explored in the future.</p>
</section>
<section id="acknowledgment" class="level2">
<h2 class="anchored" data-anchor-id="acknowledgment">Acknowledgment</h2>
<p>This work was made possible through funding from the Institute of Education Sciences, U.S. Department of Education, Grant R305D210044.</p>
</section>
<section id="license" class="level2">
<h2 class="anchored" data-anchor-id="license">License</h2>
<p>The code on this page is copyrighted by Edgar Merkle and licensed under the GPLv3 license:</p>
<p><a href="https://www.gnu.org/licenses/gpl-3.0.en.html">https://www.gnu.org/licenses/gpl-3.0.en.html</a></p>
<p>The text and figures on this page are copyrighted by Edgar Merkle and licensed under the CC BY-NC 4.0 license:</p>
<p><a href="https://creativecommons.org/licenses/by-nc/4.0/">https://creativecommons.org/licenses/by-nc/4.0/</a></p>
</section>
<section id="computing-environment" class="level2">
<h2 class="anchored" data-anchor-id="computing-environment">Computing Environment</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 22.04.3 LTS

Matrix products: default
BLAS:   /usr/lib/x86_64-linux-gnu/atlas/libblas.so.3.10.3 
LAPACK: /usr/lib/x86_64-linux-gnu/atlas/liblapack.so.3.10.3;  LAPACK version 3.10.0

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
 [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

time zone: America/Chicago
tzcode source: system (glibc)

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] ggplot2_3.4.3       mnormt_2.1.1        tmvnsim_1.0-2      
[4] future.apply_1.11.0 future_1.33.0       loo_2.6.0          
[7] blavaan_0.4-9.1157  Rcpp_1.0.11         lavaan_0.6-15      

loaded via a namespace (and not attached):
 [1] gtable_0.3.4        xfun_0.40           htmlwidgets_1.6.2  
 [4] processx_3.8.2      inline_0.3.19       CompQuadForm_1.4.3 
 [7] lattice_0.21-8      callr_3.7.3         quadprog_1.5-8     
[10] vctrs_0.6.3         tools_4.3.1         ps_1.7.5           
[13] generics_0.1.3      stats4_4.3.1        parallel_4.3.1     
[16] sandwich_3.0-2      tibble_3.2.1        fansi_1.0.4        
[19] pkgconfig_2.0.3     Matrix_1.6-1        checkmate_2.2.0    
[22] desc_1.4.2          RcppParallel_5.1.7  lifecycle_1.0.3    
[25] farver_2.1.1        compiler_4.3.1      munsell_0.5.0      
[28] codetools_0.2-19    htmltools_0.5.6     bayesplot_1.10.0   
[31] yaml_2.3.7          pillar_1.9.0        crayon_1.5.2       
[34] MASS_7.3-60         StanHeaders_2.26.27 parallelly_1.36.0  
[37] rstan_2.21.8        tidyselect_1.2.0    digest_0.6.33      
[40] mvtnorm_1.2-2       listenv_0.9.0       nonnest2_0.5-6     
[43] dplyr_1.1.2         labeling_0.4.2      rprojroot_2.0.3    
[46] fastmap_1.1.1       grid_4.3.1          colorspace_2.1-0   
[49] cli_3.6.1           magrittr_2.0.3      pkgbuild_1.4.2     
[52] utf8_1.2.3          pbivnorm_0.6.0      withr_2.5.0        
[55] backports_1.4.1     prettyunits_1.1.1   scales_1.2.1       
[58] rmarkdown_2.24      globals_0.16.2      matrixStats_1.0.0  
[61] gridExtra_2.3       zoo_1.8-12          coda_0.19-4        
[64] evaluate_0.21       knitr_1.43          rstantools_2.3.1.1 
[67] rlang_1.1.1         glue_1.6.2          pkgload_1.3.2.1    
[70] rstudioapi_0.15.0   jsonlite_1.8.7      R6_2.5.1           </code></pre>
</div>
</div>
</section>
<section id="references" class="level2">




</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-albchi93" class="csl-entry" role="listitem">
Albert, James H., and Siddhartha Chib. 1993. <span>“Bayesian Analysis of Binary and Polychotomous Response Data.”</span> <em>Journal of the American Statistical Association</em> 88 (422): 669–79.
</div>
<div id="ref-azzgen20" class="csl-entry" role="listitem">
Azzalini, A., and A. Genz. 2020. <em>The <span>R</span> Package <code>mnormt</code>: The Multivariate Normal and <span class="math inline">\(t\)</span> Distributions (Version 2.0.2)</em>. <a href="http://azzalini.stat.unipd.it/SW/Pkg-mnormt/">http://azzalini.stat.unipd.it/SW/Pkg-mnormt/</a>.
</div>
<div id="ref-tn21" class="csl-entry" role="listitem">
Botev, Zdravko, and Leo Belzile. 2021. <em>TruncatedNormal: Truncated Multivariate Normal and Student Distributions</em>. <a href="https://CRAN.R-project.org/package=TruncatedNormal">https://CRAN.R-project.org/package=TruncatedNormal</a>.
</div>
<div id="ref-tlrmvnmvt" class="csl-entry" role="listitem">
Cao, Jian, Marc G. Genton, David E. Keyes, and George M. Turkiyyah. 2022. <span>“<span class="nocase">tlrmvnmvt</span>: Computing High-Dimensional Multivariate Normal and <span>S</span>tudent-<span class="math inline">\(t\)</span> Probabilities with Low-Rank Methods in <span>R</span>.”</span> <em>Journal of Statistical Software</em> 101 (4): 1–25. <a href="https://doi.org/10.18637/jss.v101.i04">https://doi.org/10.18637/jss.v101.i04</a>.
</div>
<div id="ref-chigre98" class="csl-entry" role="listitem">
Chib, S., and E. Greenberg. 1998. <span>“Analysis of Multivariate Probit Models.”</span> <em>Biometrika</em> 85: 347–61.
</div>
<div id="ref-gen92" class="csl-entry" role="listitem">
Genz, A. 1992. <span>“Numerical Computation of the Multivariate Normal Probabilities.”</span> <em>Journal of Computational and Graphical Statistics</em> 1: 141–50.
</div>
<div id="ref-genhot21" class="csl-entry" role="listitem">
Genz, A., F. Bretz, T. Miwa, X. Mi, F. Leisch, F. Scheipl, and T. Hothorn. 2021. <em><span class="nocase">mvtnorm</span>: Multivariate Normal and t Distributions</em>. <a href="https://CRAN.R-project.org/package=mvtnorm">https://CRAN.R-project.org/package=mvtnorm</a>.
</div>
<div id="ref-merfit21" class="csl-entry" role="listitem">
Merkle, E. C., E. Fitzsimmons, J. Uanhoro, and B. Goodrich. 2021. <span>“Efficient <span>Bayesian</span> Structural Equation Modeling in <span>Stan</span>.”</span> <em>Journal of Statistical Software</em> 100 (6): 1–22. <a href="https://www.jstatsoft.org/article/view/v100i06">https://www.jstatsoft.org/article/view/v100i06</a>.
</div>
<div id="ref-merfur19" class="csl-entry" role="listitem">
Merkle, E. C., D. Furr, and S. Rabe-Hesketh. 2019. <span>“<span>Bayesian</span> Comparison of Latent Variable Models: <span>Conditional</span> Versus Marginal Likelihoods.”</span> <em>Psychometrika</em> 84: 802–29. <a href="https://arxiv.org/abs/1802.04452">https://arxiv.org/abs/1802.04452</a>.
</div>
</div></section><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></div></div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{merkle2022,
  author = {Merkle, Edgar C.},
  title = {Adventures in Ordinal Model Likelihoods},
  date = {2022-11-10},
  url = {https://ecmerkle.github.io/cs/ord_ic.html},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-merkle2022" class="csl-entry quarto-appendix-citeas" role="listitem">
Merkle, Edgar C. 2022. <span>“Adventures in Ordinal Model
Likelihoods.”</span> November 10, 2022. <a href="https://ecmerkle.github.io/cs/ord_ic.html">https://ecmerkle.github.io/cs/ord_ic.html</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>